# cenz-hyenz

Автоматическая цензура мата в видео и аудиофайлах с GPU-ускорением.

Использует [faster-whisper](https://github.com/SYSTRAN/faster-whisper) (CTranslate2) для транскрипции речи с пословными таймстемпами, затем находит матерные слова по словарю и заменяет их тишиной или бипом. Работает в 4–6 раз быстрее стандартного Whisper.

## Возможности

- Обработка видео (MKV, MP4, AVI, MOV, WebM и др.) и аудио (MP3, WAV, FLAC, OGG и др.)
- Транскрипция через faster-whisper с CUDA (float16) — оптимизировано под RTX 4060
- Пословные таймстемпы для точной цензуры
- Поддержка нескольких аудиодорожек в видео (выборочная обработка)
- Два режима цензуры: тишина (по умолчанию) или бип
- Кеширование транскриптов и промежуточных файлов — повторный запуск мгновенный
- Пакетная обработка нескольких файлов за раз
- Сохранение видео, субтитров и метаданных дорожек без перекодирования
- VAD-фильтр для пропуска тишины при транскрипции
- Автопропуск тихих дорожек (комментарии режиссёра и т.п.)
- Прогресс-бары для всех длительных операций

## Требования

- **Python 3.10+**
- **FFmpeg** в PATH (ffmpeg + ffprobe)
- **NVIDIA GPU** с поддержкой CUDA (протестировано на RTX 4060)
- **CUDA Toolkit** и **cuDNN** (для faster-whisper)

## Установка

```bash
git clone https://github.com/<your-username>/cenz-hyenz.git
cd cenz-hyenz

python -m venv venv
# Windows
.\venv\Scripts\activate
# Linux/macOS
source venv/bin/activate

pip install faster-whisper numpy soundfile
```

> На Windows можно запускать через `censor.bat` — он автоматически активирует venv.

## Использование

```bash
# Базовое использование — видео, все дорожки, модель medium
python censor.py video.mkv

# Аудиофайл
python censor.py podcast.mp3

# Несколько файлов
python censor.py *.mkv *.mp3

# Модель large-v3 (точнее, но медленнее)
python censor.py video.mkv -m large-v3

# Только определённые аудиодорожки
python censor.py video.mkv -t 0,2

# Бип вместо тишины
python censor.py video.mkv --beep

# Указать выходной файл
python censor.py video.mkv -o output.mkv

# Показать информацию о дорожках
python censor.py video.mkv --info

# Очистить кеш
python censor.py --clear-cache
```

### Параметры

| Параметр | Описание |
|---|---|
| `input` | Входные файлы (видео или аудио), поддерживает glob-паттерны |
| `-o`, `--output` | Выходной файл (только для одного входного) |
| `-m`, `--model` | Модель Whisper: `tiny`, `base`, `small`, `medium` (по умолчанию), `large-v2`, `large-v3` |
| `-t`, `--tracks` | Номера аудиодорожек через запятую, например `0,2,4` |
| `--beep` | Бип (1000 Гц) вместо тишины |
| `--info` | Показать аудиодорожки без обработки |
| `--clear-cache` | Удалить все кешированные данные |

## Словарь мата

Файл `swears.txt` содержит корни и основы матерных слов (один на строку). Скрипт ищет эти основы с учётом возможных окончаний через regex. Комментарии начинаются с `#`.

Поиск файла словаря происходит в следующем порядке:
1. `swears.txt` в папке скрипта
2. `~/.config/censor/swears.txt`

Словарь можно редактировать — добавлять или убирать слова по необходимости. Раскомментируйте строки для дополнительных категорий (например, слова на «хер», туалетная тема и пр.), если нужна более строгая цензура.

## Как это работает

1. **Извлечение аудио** — ffmpeg извлекает аудиодорожку в WAV (16 кГц, моно) для Whisper
2. **Проверка на тишину** — тихие дорожки (< -50 дБ) пропускаются
3. **Транскрипция** — faster-whisper распознаёт речь с пословными таймстемпами (VAD-фильтр ускоряет процесс)
4. **Поиск мата** — каждое слово проверяется по словарю с учётом словоформ
5. **Цензура** — извлекается полнокачественный WAV, мат заменяется тишиной/бипом с отступом ±50 мс
6. **Кодирование** — обработанный WAV кодируется обратно в оригинальный кодек (AAC, MP3, Opus и др.)
7. **Сборка** — для видео: видеопоток и субтитры копируются без изменений, аудио подставляется обработанное

## Кеширование

Кеш хранится в папке `cache/` рядом со скриптом. Для каждого файла создаётся подпапка на основе имени, размера и даты модификации. Кешируются:

- Извлечённые WAV-файлы (16 кГц и полнокачественные)
- JSON-транскрипты
- Готовые обработанные аудиодорожки
- Маркеры тихих дорожек

При повторном запуске скрипт пропустит все уже обработанные этапы. Очистить кеш: `python censor.py --clear-cache`.

## Поддерживаемые форматы

**Видео:** MKV, MP4, AVI, MOV, WebM, TS, M2TS, WMV

**Аудио:** MP3, WAV, FLAC, OGG, M4A, AAC, WMA, Opus

**Аудиокодеки** (кодирование обратно): AAC, MP3, Opus, Vorbis, FLAC, AC3, EAC3, DTS

## Настройки

Константы в начале `censor.py`:

| Константа | По умолчанию | Описание |
|---|---|---|
| `DEFAULT_MODEL` | `"medium"` | Модель Whisper по умолчанию |
| `SILENCE_THRESHOLD_DB` | `-50` | Порог тишины (дБ) для пропуска дорожки |
| `BEEP_FREQ` | `1000` | Частота бипа (Гц) |
| `PADDING_MS` | `50` | Расширение цензуры с каждой стороны (мс) |

## Выбор модели

| Модель | VRAM | Скорость | Качество |
|---|---|---|---|
| `tiny` | ~1 ГБ | ★★★★★ | ★★ |
| `base` | ~1 ГБ | ★★★★ | ★★★ |
| `small` | ~2 ГБ | ★★★★ | ★★★ |
| `medium` | ~5 ГБ | ★★★ | ★★★★ |
| `large-v2` | ~6 ГБ | ★★ | ★★★★★ |
| `large-v3` | ~6 ГБ | ★★ | ★★★★★ |

Для RTX 4060 (8 ГБ VRAM) все модели влезают в float16. `medium` — оптимальный баланс скорости и качества для русского языка.

## Лицензия

MIT
